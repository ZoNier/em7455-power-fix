#!/bin/bash

MAX_RETRIES=10
RETRY_DELAY=3

get_modem_id() {
    mmcli -L 2>/dev/null | grep -oP '/Modem/\K\d+' | head -n1
}

get_cdc_wdm() {
    local modem_id="$1"
    mmcli -m "$modem_id" 2>/dev/null | \
        grep -oP 'cdc-wdm\d+' | head -n1
}

retry=0

while [ $retry -lt $MAX_RETRIES ]; do
    MODEM_ID=$(get_modem_id)

    if [ -z "$MODEM_ID" ]; then
        echo "[INFO] Modem not found, retrying..."
        sleep $RETRY_DELAY
        ((retry++))
        continue
    fi

    echo "[OK] Modem found: $MODEM_ID"

    CDC_WDM=$(get_cdc_wdm "$MODEM_ID")

    if [ -z "$CDC_WDM" ]; then
        echo "[INFO] cdc-wdm not ready yet..."
        sleep $RETRY_DELAY
        ((retry++))
        continue
    fi

    echo "[OK] Using /dev/$CDC_WDM"

    echo "[INFO] Sending FCC unlock..."
    qmicli --device="/dev/$CDC_WDM" \
           --device-open-proxy \
           --dms-set-fcc-authentication && break

    echo "[WARN] FCC unlock failed, retrying..."
    sleep $RETRY_DELAY
    ((retry++))
done

if [ $retry -ge $MAX_RETRIES ]; then
    echo "[ERROR] Failed to initialize modem"
    exit 1
fi

echo "[SUCCESS] Modem ready"
